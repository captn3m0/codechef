{"category_name":"hard","status":"success","problem_code":"CURMAT","problem_name":"Curious Matrix","body":"### Read problem statements in [Hindi](https:\/\/www.codechef.com\/download\/translated\/JAN21\/hindi\/CURMAT.pdf), [Bengali](https:\/\/www.codechef.com\/download\/translated\/JAN21\/bengali\/CURMAT.pdf), [Mandarin Chinese](https:\/\/www.codechef.com\/download\/translated\/JAN21\/mandarin\/CURMAT.pdf), [Russian](https:\/\/www.codechef.com\/download\/translated\/JAN21\/russian\/CURMAT.pdf), and [Vietnamese](https:\/\/www.codechef.com\/download\/translated\/JAN21\/vietnamese\/CURMAT.pdf) as well.\r\n\r\nYou are given a prime $p$ and a matrix $M$ with $N$ rows (numbered $1$ through $N$) and $N$ columns (numbered $1$ through $N$). For each row $r$ and column $c$, the cell in row $r$ and column $c$ can either be empty or contain an integer $M_{r, c}$. Initially, all cells are empty.\r\n\r\nNow you should process $Q$ queries. In each query, you are given integers $x$, $y$ and $v$ and you should do the following:\r\n- If the cell $(x,y)$ is empty before this query, put the value $v$ in it, i.e. set $M_{x, y}$ to $v$.\r\n- Otherwise, i.e. if the cell $(x,y)$ is not empty, make this cell empty again. It is guaranteed that in such a case, $M_{x, y} = v$ before this query; $v$ is provided for convenience.\r\n- Afterwards, Chef wants you to find the number of ways to fill all empty cells with (not necessarily the same) integers in such a way that the resulting matrix is *curious*. Since this number may be large, compute it modulo $10^9 + 7$.\r\n\r\nIn particular, when there are no empty cells in the matrix, the answer is $1$ if the matrix is curious or $0$ if it is not curious.\r\n\r\nIn a curious matrix:\r\n- Each cell contains an integer between $1$ and $p-1$ inclusive.\r\n- For each non-trivial square [submatrix](https:\/\/mathworld.wolfram.com\/Submatrix.html) $A$ of $M$ (a submatrix containing more than one cell), its determinant $|A|$ is a multiple of $p$.\r\n\r\nFor example, consider the following matrix.\r\n$$\r\nA=\r\n\\begin{bmatrix}\r\n1 & 2 & 1 \\\\\r\n2 & 4 & 2 \\\\\r\n2 & 4 & 2 \\\\\r\n\\end{bmatrix}\r\n$$\r\n\r\nThis matrix is curious. For the prime $p=5$, each of the elements of the matrix is in the range $[1,p-1]$. Also, the determinant of each non-trivial square submatrix (there are five of them) is a multiple of the given prime \u2015 for example, the determinant of the whole matrix is $0$.\r\n\r\n$$\r\nB=\r\n\\begin{bmatrix}\r\n3 & 1 \\\\\r\n1 & 4 \\\\\r\n\\end{bmatrix}\r\n$$\r\n\r\nThe above matrix is not a curious matrix for $p=5$, since the determinant of the only non-trivial square submatrix (which is the whole matrix) is $11$, not a multiple of $p$.\r\n\r\n### Input\r\n- The first line of the input contains three space-separated integers $N$, $Q$ and $p$.\r\n- $Q$ lines follow. Each of these lines contains three space-separated integers $x$, $y$ and $v$ describing a query.\r\n\r\n### Output\r\nAfter performing each query, print a single line containing one integer \u2015 the number of ways to form a curious matrix, modulo $10^9+7$.\r\n\r\n### Constraints\r\n- $2 \\leq N \\leq 10^5$\r\n- $1 \\leq Q \\leq 10^5$\r\n- $2 \\leq p \\leq 998,244,353$\r\n- $p$ is a prime number\r\n- $1 \\leq x,y \\leq N$\r\n- $1 \\leq v \\leq p-1$\r\n\r\n### Subtasks\r\n**Subtask #1 (20 points):** $1 \\leq N,Q \\leq 300$\r\n\r\n**Subtask #2 (20 points):** no two queries affect the same cell, i.e. the pairs $(x,y)$ for all queries are pairwise distinct\r\n\r\n**Subtask #3 (20 points):** after each query, there is at least one way to construct a curious matrix\r\n\r\n**Subtask #4 (40 points):** original constraints\r\n\r\n### Example Input\r\n```\r\n2 6 5\r\n1 1 3\r\n1 2 1\r\n2 1 1\r\n2 2 4\r\n1 2 1\r\n2 2 4\r\n```\r\n\r\n### Example Output\r\n```\r\n16\r\n4\r\n1\r\n0\r\n1\r\n4\r\n```\r\n\r\n### Explanation\r\nThe only non-trivial square submatrix here is the whole matrix.\r\n\r\nIn the $4$-th query, the matrix is completely filled, but it is not curious for $p=5$, so the answer is $0$.\r\n\r\nAfter the $5$-th query, there are $3$ filled cells: $(1,1) \\rightarrow 3$, $(2,1) \\rightarrow 1$ and $(2,2) \\rightarrow 4$. The cell $(1,2)$ is empty and if we want the determinant of the matrix to be divisible by $p=5$, we have to put $2$ in this cell. Then the determinant is $3 \\cdot 4 - 1 \\cdot 2 = 10$.\r\n\n<aside style='background: #f8f8f8;padding: 10px 15px;'><div>All submissions for this problem are available.<\/div><\/aside>","problemComponents":{"constraints":"","constraintsState":false,"subtasks":"","subtasksState":false,"statement":"### Read problem statements in [Hindi](https:\/\/www.codechef.com\/download\/translated\/JAN21\/hindi\/CURMAT.pdf), [Bengali](https:\/\/www.codechef.com\/download\/translated\/JAN21\/bengali\/CURMAT.pdf), [Mandarin Chinese](https:\/\/www.codechef.com\/download\/translated\/JAN21\/mandarin\/CURMAT.pdf), [Russian](https:\/\/www.codechef.com\/download\/translated\/JAN21\/russian\/CURMAT.pdf), and [Vietnamese](https:\/\/www.codechef.com\/download\/translated\/JAN21\/vietnamese\/CURMAT.pdf) as well.\r\n\r\nYou are given a prime $p$ and a matrix $M$ with $N$ rows (numbered $1$ through $N$) and $N$ columns (numbered $1$ through $N$). For each row $r$ and column $c$, the cell in row $r$ and column $c$ can either be empty or contain an integer $M_{r, c}$. Initially, all cells are empty.\r\n\r\nNow you should process $Q$ queries. In each query, you are given integers $x$, $y$ and $v$ and you should do the following:\r\n- If the cell $(x,y)$ is empty before this query, put the value $v$ in it, i.e. set $M_{x, y}$ to $v$.\r\n- Otherwise, i.e. if the cell $(x,y)$ is not empty, make this cell empty again. It is guaranteed that in such a case, $M_{x, y} = v$ before this query; $v$ is provided for convenience.\r\n- Afterwards, Chef wants you to find the number of ways to fill all empty cells with (not necessarily the same) integers in such a way that the resulting matrix is *curious*. Since this number may be large, compute it modulo $10^9 + 7$.\r\n\r\nIn particular, when there are no empty cells in the matrix, the answer is $1$ if the matrix is curious or $0$ if it is not curious.\r\n\r\nIn a curious matrix:\r\n- Each cell contains an integer between $1$ and $p-1$ inclusive.\r\n- For each non-trivial square [submatrix](https:\/\/mathworld.wolfram.com\/Submatrix.html) $A$ of $M$ (a submatrix containing more than one cell), its determinant $|A|$ is a multiple of $p$.\r\n\r\nFor example, consider the following matrix.\r\n$$\r\nA=\r\n\\begin{bmatrix}\r\n1 & 2 & 1 \\\\\r\n2 & 4 & 2 \\\\\r\n2 & 4 & 2 \\\\\r\n\\end{bmatrix}\r\n$$\r\n\r\nThis matrix is curious. For the prime $p=5$, each of the elements of the matrix is in the range $[1,p-1]$. Also, the determinant of each non-trivial square submatrix (there are five of them) is a multiple of the given prime \u2015 for example, the determinant of the whole matrix is $0$.\r\n\r\n$$\r\nB=\r\n\\begin{bmatrix}\r\n3 & 1 \\\\\r\n1 & 4 \\\\\r\n\\end{bmatrix}\r\n$$\r\n\r\nThe above matrix is not a curious matrix for $p=5$, since the determinant of the only non-trivial square submatrix (which is the whole matrix) is $11$, not a multiple of $p$.\r\n\r\n### Input\r\n- The first line of the input contains three space-separated integers $N$, $Q$ and $p$.\r\n- $Q$ lines follow. Each of these lines contains three space-separated integers $x$, $y$ and $v$ describing a query.\r\n\r\n### Output\r\nAfter performing each query, print a single line containing one integer \u2015 the number of ways to form a curious matrix, modulo $10^9+7$.\r\n\r\n### Constraints\r\n- $2 \\leq N \\leq 10^5$\r\n- $1 \\leq Q \\leq 10^5$\r\n- $2 \\leq p \\leq 998,244,353$\r\n- $p$ is a prime number\r\n- $1 \\leq x,y \\leq N$\r\n- $1 \\leq v \\leq p-1$\r\n\r\n### Subtasks\r\n**Subtask #1 (20 points):** $1 \\leq N,Q \\leq 300$\r\n\r\n**Subtask #2 (20 points):** no two queries affect the same cell, i.e. the pairs $(x,y)$ for all queries are pairwise distinct\r\n\r\n**Subtask #3 (20 points):** after each query, there is at least one way to construct a curious matrix\r\n\r\n**Subtask #4 (40 points):** original constraints","inputFormat":"","inputFormatState":false,"outputFormat":"","outputFormatState":false,"sampleTestCases":[{"id":"1","input":"2 6 5\r\n1 1 3\r\n1 2 1\r\n2 1 1\r\n2 2 4\r\n1 2 1\r\n2 2 4","output":"16\r\n4\r\n1\r\n0\r\n1\r\n4","explanation":"The only non-trivial square submatrix here is the whole matrix.\r\n\r\nIn the $4$-th query, the matrix is completely filled, but it is not curious for $p=5$, so the answer is $0$.\r\n\r\nAfter the $5$-th query, there are $3$ filled cells: $(1,1) \\rightarrow 3$, $(2,1) \\rightarrow 1$ and $(2,2) \\rightarrow 4$. The cell $(1,2)$ is empty and if we want the determinant of the matrix to be divisible by $p=5$, we have to put $2$ in this cell. Then the determinant is $3 \\cdot 4 - 1 \\cdot 2 = 10$.","isDeleted":false}]},"video_editorial_url":"https:\/\/youtu.be\/CugVd0a2kMM","languages_supported":"CPP14, C, JAVA, PYTH 3.6, CPP17, PYTH, PYP3, CS2, ADA, PYPY, TEXT, PAS fpc, NODEJS, RUBY, PHP, GO, HASK, TCL, PERL, SCALA, LUA, kotlin, BASH, JS, LISP sbcl, rust, PAS gpc, BF, CLOJ, R, D, CAML, FORT, ASM, swift, FS, WSPC, LISP clisp, SQL, SCM guile, PERL6, ERL, CLPS, ICK, NICE, PRLG, ICON, COB, SCM chicken, PIKE, SCM qobi, ST, SQLQ, NEM","max_timelimit":"1","source_sizelimit":"50000","problem_author":"shaanknight","problem_author_html_handle":"<span \n            class='rating' \n            style='display: inline-block; \n                    font-size: 10px; \n                    background: #FFBF00;\n                    padding: 0 3px; \n                    line-height: 1.3; \n                    color: white;\n                    margin-right: 2px;'>5&#9733;<\/span><span class='m-username--link'>shaanknight<\/span>","problem_tester":"","problem_tester_html_handle":"","date_added":"12-10-2020","tags":"<a class='problem-tag-small ' href='\/tags\/problems\/ad-hoc'>ad-hoc<\/a>, <a class='problem-tag-small ' href='\/tags\/problems\/disjoint-set-union'>disjoint-set-union<\/a>, <a class='problem-tag-small ' href='\/tags\/problems\/hard'>hard<\/a>, <a class='problem-tag-small ' href='\/tags\/problems\/jan21'>jan21<\/a>, <a class='problem-tag-small ' href='\/tags\/problems\/linear-algebra'>linear-algebra<\/a>, <a class='problem-tag-small ' href='\/tags\/problems\/segment-tree'>segment-tree<\/a>, <a class='problem-tag-small ' href='\/tags\/problems\/shaanknight'>shaanknight<\/a>","problem_difficulty_level":"Hard","user_zen_mode":false,"best_tag":"Ad Hoc","editorial_url":"https:\/\/discuss.codechef.com\/problems\/CURMAT","time":{"view_start_date":1104528600,"submit_start_date":1104528600,"visible_start_date":1104528600,"end_date":1735669800,"current":1643797993},"user":{"username":null,"access":"default"},"todo":false,"problem_status":"unattempted","is_direct_submittable":false,"problemDiscussURL":"https:\/\/discuss.codechef.com\/search?q=CURMAT","is_proctored":false,"is_user_verified_for_proctoring":null,"visitedContests":[]}